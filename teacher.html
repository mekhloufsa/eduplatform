<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Espace Enseignant - EduPlatform</title>
    <link rel="stylesheet" href="frontend/css/teacher.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e2ff;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9ff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e2ff;
        }

        .tab.active {
            background: #5f6cff;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .file-upload-area {
            border: 3px dashed #5f6cff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .file-upload-area:hover {
            background: #e8ebff;
            border-color: #4a58ff;
        }

        .file-upload-area.dragover {
            background: #e0e2ff;
            transform: scale(1.02);
        }

        .file-upload-area i {
            font-size: 48px;
            color: #5f6cff;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #5f6cff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .btn-create {
            background: #5f6cff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-create:hover {
            background: #4a58ff;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #5f6cff;
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .course-item,
        .quiz-item,
        .assignment-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .course-item h3,
        .quiz-item h3,
        .assignment-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .course-meta,
        .quiz-meta,
        .assignment-meta {
            display: flex;
            gap: 20px;
            color: #888;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Styles pour le constructeur de quiz */
        .question-builder {
            background: #f8f9ff;
            border: 2px solid #e0e2ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background: #5f6cff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .option-row input[type="text"] {
            flex: 1;
        }

        .option-row input[type="radio"],
        .option-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn-add-option,
        .btn-add-question {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-remove-question {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .questions-list {
            margin-top: 30px;
        }

        .saved-question {
            background: white;
            border-left: 4px solid #5f6cff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .saved-question h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .saved-options {
            margin-left: 20px;
        }

        .saved-options li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .correct-answer {
            color: #28a745;
            font-weight: bold;
        }

        .wrong-answer {
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .course-meta,
            .quiz-meta,
            .assignment-meta {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <header class="navbar">
        <h2>EduPlatform | Enseignant</h2>
        <nav class="nav-links">
            <a href="#" class="active" id="nav-dashboard" onclick="showSection('dashboard')">Tableau de bord</a>
            <a href="#" id="nav-courses" onclick="showSection('courses')">Mes Cours</a>
            <a href="#" id="nav-create" onclick="showSection('create')">Cr√©er un Cours</a>
            <a href="#" id="nav-quizzes" onclick="showSection('quizzes')">Quiz & √âvaluations</a>
            <a href="#" id="nav-assignments" onclick="showSection('assignments')">Devoirs</a>
        </nav>
        <button class="logout" onclick="logout()">D√©connexion</button>
    </header>

    <!-- Content -->
    <div class="container">
        <!-- Tableau de bord -->
        <div id="dashboard-section" class="section active">
            <h1>Tableau de bord Enseignant</h1>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-courses">0</div>
                    <div class="stat-label">Cours cr√©√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-students">0</div>
                    <div class="stat-label">√âtudiants inscrits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-quizzes">0</div>
                    <div class="stat-label">Quiz cr√©√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-assignments">0</div>
                    <div class="stat-label">Devoirs cr√©√©s</div>
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h3>Activit√©s r√©centes</h3>
                <div id="recent-activities">
                    <p style="color: #666; text-align: center; padding: 20px;">Aucune activit√© r√©cente</p>
                </div>
            </div>
        </div>

        <!-- Section Mes Cours -->
        <div id="courses-section" class="section">
            <h1>Mes Cours</h1>
            <div id="courses-list">
                <p style="color: #666; text-align: center; padding: 40px;">Chargement des cours...</p>
            </div>
        </div>

        <!-- Section Cr√©ation de Cours -->
        <div id="create-section" class="section">
            <h1>Cr√©er un Nouveau Cours</h1>

            <form id="create-course-form">
                <div class="card">
                    <h3>Informations du cours</h3>
                    <div class="form-group">
                        <label for="course-title">Titre du cours *</label>
                        <input type="text" id="course-title" placeholder="Ex: Introduction √† JavaScript" required>
                    </div>
                    <div class="form-group">
                        <label for="course-category">Cat√©gorie *</label>
                        <select id="course-category" required>
                            <option value="">S√©lectionnez une cat√©gorie</option>
                            <option value="D√©veloppement Web">D√©veloppement Web</option>
                            <option value="Data Science">Data Science</option>
                            <option value="Intelligence Artificielle">Intelligence Artificielle</option>
                            <option value="Cybers√©curit√©">Cybers√©curit√©</option>
                            <option value="D√©veloppement Mobile">D√©veloppement Mobile</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="course-description">Description *</label>
                        <textarea id="course-description" rows="4" placeholder="D√©crivez votre cours..."
                            required></textarea>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>Supports de cours (optionnel)</h3>
                    <div class="file-upload-area" id="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Cliquez pour s√©lectionner des fichiers</strong></p>
                        <p>ou glissez-d√©posez ici</p>
                        <p style="font-size: 0.85rem; color: #999;">PDF, DOC, PPT, MP4, MP3, JPG, PNG (max 10MB)</p>
                        <input type="file" id="course-files" multiple style="display: none;">
                    </div>
                    <div class="file-list" id="file-list"></div>
                </div>

                <div style="margin-top: 30px;">
                    <button type="submit" class="btn-create" id="submit-course">
                        <i class="fas fa-save"></i> Cr√©er le cours
                    </button>
                </div>
            </form>
        </div>

        <!-- Section Quiz & √âvaluations -->
        <div id="quizzes-section" class="section">
            <h1>Quiz & √âvaluations</h1>

            <div class="tabs">
                <button class="tab active" onclick="switchTab(this, 'create-quiz-tab')">Cr√©er un Quiz</button>
                <button class="tab" onclick="switchTab(this, 'manage-quizzes-tab')">Mes Quiz</button>
                <button class="tab" onclick="switchTab(this, 'build-quiz-tab')">Construire Questions</button>
            </div>

            <!-- Cr√©er un Quiz -->
            <div id="create-quiz-tab" class="tab-content active">
                <div class="card">
                    <form id="create-quiz-form">
                        <div class="form-group">
                            <label for="quiz-course">Cours concern√© *</label>
                            <select id="quiz-course" required>
                                <option value="">Choisir un cours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quiz-title">Titre du quiz *</label>
                            <input type="text" id="quiz-title" placeholder="Ex: Quiz - Chapitre 1" required>
                        </div>
                        <div class="form-group">
                            <label for="quiz-description">Description</label>
                            <textarea id="quiz-description" rows="2" placeholder="Description du quiz..."></textarea>
                        </div>
                        <button type="submit" class="btn-create">Cr√©er le quiz</button>
                    </form>
                </div>
            </div>

            <!-- Mes Quiz -->
            <div id="manage-quizzes-tab" class="tab-content">
                <div class="card">
                    <h3>Vos quiz</h3>
                    <div id="quizzes-list">
                        <p style="color: #666; text-align: center;">Aucun quiz cr√©√©</p>
                    </div>
                </div>
            </div>

            <!-- Construire Questions -->
            <div id="build-quiz-tab" class="tab-content">
                <div class="card">
                    <h3>Construire les questions d'un quiz</h3>
                    <div class="form-group">
                        <label for="build-quiz-select">S√©lectionner un quiz *</label>
                        <select id="build-quiz-select" onchange="loadQuizQuestions()">
                            <option value="">Choisir un quiz</option>
                        </select>
                    </div>
                </div>

                <!-- Constructeur de question -->
                <div id="question-builder-container" style="display: none;">
                    <div class="question-builder">
                        <div class="question-header">
                            <span class="question-number">Nouvelle Question</span>
                            <button type="button" class="btn-remove-question"
                                onclick="resetQuestionBuilder()">R√©initialiser</button>
                        </div>

                        <div class="form-group">
                            <label>Question *</label>
                            <input type="text" id="question-text" placeholder="Entrez votre question...">
                        </div>

                        <div class="form-group">
                            <label>Type de question</label>
                            <select id="question-type" onchange="updateOptionInputType()">
                                <option value="multiple_choice">Choix multiple (une r√©ponse)</option>
                                <option value="multiple_answer">Choix multiple (plusieurs r√©ponses)</option>
                                <option value="true_false">Vrai/Faux</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" id="question-points" value="1" min="1">
                        </div>

                        <div class="form-group">
                            <label>R√©ponses possibles *</label>
                            <div id="options-container">
                                <!-- Les options seront ajout√©es ici dynamiquement -->
                            </div>
                            <button type="button" class="btn-add-option" onclick="addOption()">
                                <i class="fas fa-plus"></i> Ajouter une option
                            </button>
                        </div>

                        <div class="form-group">
                            <label>Explication (optionnelle)</label>
                            <textarea id="question-explanation" rows="2"
                                placeholder="Explication de la r√©ponse correcte..."></textarea>
                        </div>

                        <button type="button" class="btn-create" onclick="saveQuestion()"
                            style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-save"></i> Ajouter cette question
                        </button>
                    </div>

                    <!-- Liste des questions existantes -->
                    <div class="card questions-list">
                        <h3>Questions du quiz</h3>
                        <div id="saved-questions-list">
                            <p style="color: #666; text-align: center;">Aucune question ajout√©e</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Devoirs -->
        <div id="assignments-section" class="section">
            <h1>Gestion des Devoirs</h1>

            <div class="tabs">
                <button class="tab active" onclick="switchTab(this, 'create-assignment-tab')">Cr√©er un Devoir</button>
                <button class="tab" onclick="switchTab(this, 'manage-assignments-tab')">Mes Devoirs</button>
            </div>

            <!-- Cr√©er un Devoir -->
            <div id="create-assignment-tab" class="tab-content active">
                <div class="card">
                    <form id="create-assignment-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="assignment-course">Cours concern√© *</label>
                            <select id="assignment-course" required>
                                <option value="">Choisir un cours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assignment-title">Titre du devoir *</label>
                            <input type="text" id="assignment-title" placeholder="Ex: Projet final - Application Web"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="assignment-description">Description *</label>
                            <textarea id="assignment-description" rows="4"
                                placeholder="D√©crivez le devoir, les consignes, les crit√®res d'√©valuation..."
                                required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignment-due-date">Date de remise *</label>
                                <input type="datetime-local" id="assignment-due-date" required>
                            </div>
                            <div class="form-group">
                                <label for="assignment-points">Points maximum</label>
                                <input type="number" id="assignment-points" value="100" min="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="assignment-late" style="width: auto; margin-right: 8px;">
                                Autoriser les remises en retard
                            </label>
                        </div>

                        <!-- Upload de fichier pour le devoir -->
                        <div class="form-group">
                            <label>Fichier du devoir (sujet, mod√®le, etc.)</label>
                            <div class="file-upload-area" id="assignment-file-area" style="padding: 20px;">
                                <i class="fas fa-file-upload"></i>
                                <p><strong>Cliquez pour s√©lectionner un fichier</strong></p>
                                <p style="font-size: 0.85rem; color: #999;">PDF, DOC, ZIP (max 10MB)</p>
                                <input type="file" id="assignment-file" name="file" accept=".pdf,.doc,.docx,.zip,.rar"
                                    style="display: none;">
                            </div>
                            <div id="assignment-file-preview"></div>
                        </div>

                        <button type="submit" class="btn-create" id="submit-assignment">
                            <i class="fas fa-save"></i> Cr√©er le devoir
                        </button>
                    </form>
                </div>
            </div>

            <!-- Mes Devoirs -->
            <div id="manage-assignments-tab" class="tab-content">
                <div class="card">
                    <h3>Vos devoirs</h3>
                    <div id="assignments-list">
                        <p style="color: #666; text-align: center;">Aucun devoir cr√©√©</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/eduplatform/backend/api';
        let selectedFiles = [];
        let currentOptions = [];
        let optionCounter = 0;
        let currentAssignmentId = null;

        // ============ NAVIGATION ============
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionName + '-section').classList.add('active');
            document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + sectionName).classList.add('active');

            if (sectionName === 'courses') loadTeacherCourses();
            else if (sectionName === 'dashboard') loadTeacherDashboard();
            else if (sectionName === 'quizzes') {
                loadCoursesForSelect();
                loadTeacherQuizzes();
            }
            else if (sectionName === 'assignments') {
                loadCoursesForSelect();
                loadTeacherAssignments();
            }
        }

        function switchTab(tab, contentId) {
            tab.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const section = tab.closest('.section');
            section.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(contentId).classList.add('active');
        }

        // ============ API REQUEST ============
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}/${endpoint}`;
            const token = localStorage.getItem('token');

            const defaultOptions = {
                headers: {}
            };

            if (token) {
                defaultOptions.headers['Authorization'] = 'Bearer ' + token;
            }

            const finalOptions = { ...defaultOptions, ...options };

            if (options.headers) {
                finalOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }

            if (finalOptions.body && !(finalOptions.body instanceof FormData)) {
                finalOptions.headers['Content-Type'] = 'application/json';
                if (typeof finalOptions.body === 'object') {
                    finalOptions.body = JSON.stringify(finalOptions.body);
                }
            }

            const response = await fetch(url, finalOptions);

            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else {
                const text = await response.text();
                console.error('R√©ponse non-JSON:', text.substring(0, 500));
                throw new Error('La r√©ponse du serveur n\'est pas au format JSON');
            }
        }

        // ============ DASHBOARD ============
        async function loadTeacherDashboard() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.email) return;

                const result = await apiRequest('teachers/index.php?email=' + encodeURIComponent(user.email));
                if (result.status === 'success') {
                    const stats = result.data.stats || {};
                    document.getElementById('total-courses').textContent = stats.total_courses || 0;
                    document.getElementById('total-students').textContent = stats.total_students || 0;
                    document.getElementById('total-quizzes').textContent = stats.total_quizzes || 0;

                    const assignResult = await apiRequest('teachers/assignments.php');
                    if (assignResult.status === 'success') {
                        document.getElementById('total-assignments').textContent = assignResult.data.length;
                    }
                }
            } catch (e) {
                console.error('Erreur dashboard:', e);
            }
        }

        // ============ COURS - CORRIG√â AVEC SUPPRESSION ============
        async function loadTeacherCourses() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const result = await apiRequest('teachers/index.php?email=' + encodeURIComponent(user.email));
                const container = document.getElementById('courses-list');

                if (result.status === 'success') {
                    const courses = result.data.courses || [];
                    if (courses.length === 0) {
                        container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Vous n\'avez pas encore cr√©√© de cours.</p>';
                    } else {
                        container.innerHTML = courses.map(c => `
                        <div class="course-item" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); border-left: 4px solid #5f6cff;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #333; font-size: 1.3rem;">${escapeHtml(c.title)}</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="editCourse(${c.id})" style="background: #ffc107; color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                    <button onclick="deleteCourse(${c.id}, '${escapeHtml(c.title).replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                            <p style="color: #666; margin: 10px 0; line-height: 1.6;">${escapeHtml(c.description)}</p>
                            <div class="course-meta" style="display: flex; gap: 20px; color: #888; font-size: 0.9rem; margin-top: 15px; flex-wrap: wrap;">
                                <span><i class="fas fa-users"></i> ${c.enrollment_count || 0} √©tudiants inscrits</span>
                                <span><i class="fas fa-calendar"></i> Cr√©√© le ${new Date(c.created_at).toLocaleDateString('fr-FR')}</span>
                                <span><i class="fas fa-tag"></i> ${escapeHtml(c.category)}</span>
                                <span class="badge ${c.is_public ? 'badge-success' : 'badge-warning'}" style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">
                                    ${c.is_public ? 'Public' : 'Priv√©'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    }
                }
            } catch (e) {
                console.error('Erreur cours:', e);
                const container = document.getElementById('courses-list');
                container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px;">Erreur lors du chargement des cours</p>';
            }
        }

        // ============ SUPPRESSION DE COURS ============
        async function deleteCourse(courseId, courseTitle) {
            // Demander confirmation avec le titre du cours
            const confirmed = confirm(
                `‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer le cours "${courseTitle}" ?\n\n` +
                `Cette action supprimera d√©finitivement :\n` +
                `- Tous les devoirs et soumissions\n` +
                `- Tous les quiz et questions\n` +
                `- Tous les supports de cours\n` +
                `- Toutes les inscriptions des √©tudiants\n` +
                `- Tous les messages du forum\n\n` +
                `Cette action est irr√©versible !`
            );

            if (!confirmed) return;

            // Double confirmation pour les cours avec des √©tudiants
            const doubleConfirm = confirm(
                `üö® CONFIRMATION FINALE\n\n` +
                `Tapez "SUPPRIMER" pour confirmer la suppression d√©finitive de "${courseTitle}"`
            );

            if (!doubleConfirm) return;

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');

                const result = await apiRequest('teachers/delete-course.php', {
                    method: 'DELETE',
                    body: {
                        course_id: courseId,
                        email: user.email
                    }
                });

                if (result.status === 'success') {
                    alert('‚úÖ ' + result.message);
                    // Recharger la liste des cours
                    loadTeacherCourses();
                    // Mettre √† jour le dashboard
                    loadTeacherDashboard();
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (e) {
                console.error('Erreur suppression:', e);
                alert('‚ùå Erreur lors de la suppression du cours');
            }
        }

        function editCourse(courseId) {
            alert('Fonction de modification √† impl√©menter pour le cours #' + courseId);
            // Redirection vers une page d'√©dition ou ouverture d'un modal
        }

        async function loadCoursesForSelect() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const result = await apiRequest('teachers/index.php?email=' + encodeURIComponent(user.email));
                if (result.status === 'success') {
                    const courses = result.data.courses || [];
                    const options = courses.map(c => `<option value="${c.id}">${escapeHtml(c.title)}</option>`).join('');

                    ['quiz-course', 'assignment-course', 'build-quiz-select'].forEach(id => {
                        const select = document.getElementById(id);
                        if (select) select.innerHTML = '<option value="">Choisir un cours</option>' + options;
                    });
                }
            } catch (e) {
                console.error('Erreur selects:', e);
            }
        }

        // ============ FILE UPLOAD ============
        function initFileUpload() {
            const area = document.getElementById('file-upload-area');
            const input = document.getElementById('course-files');

            area.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => handleFiles(e.target.files));
            area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('dragover'); });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            const assignArea = document.getElementById('assignment-file-area');
            const assignInput = document.getElementById('assignment-file');
            if (assignArea && assignInput) {
                assignArea.addEventListener('click', () => assignInput.click());
                assignInput.addEventListener('change', (e) => handleAssignmentFile(e.target.files[0]));
            }
        }

        function handleFiles(files) {
            const list = document.getElementById('file-list');
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert('Fichier trop grand: ' + file.name);
                    return;
                }
                selectedFiles.push(file);
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                <i class="fas fa-file"></i>
                <span class="file-name">${escapeHtml(file.name)}</span>
                <span class="file-size">${formatSize(file.size)}</span>
                <span class="remove-file" onclick="removeFile('${file.name}')"><i class="fas fa-times"></i></span>
            `;
                list.appendChild(item);
            });
        }

        function removeFile(name) {
            selectedFiles = selectedFiles.filter(f => f.name !== name);
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            selectedFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                <i class="fas fa-file"></i>
                <span class="file-name">${escapeHtml(file.name)}</span>
                <span class="file-size">${formatSize(file.size)}</span>
                <span class="remove-file" onclick="removeFile('${file.name}')"><i class="fas fa-times"></i></span>
            `;
                list.appendChild(item);
            });
        }

        function handleAssignmentFile(file) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) {
                alert('Fichier trop grand (max 10MB)');
                return;
            }
            const preview = document.getElementById('assignment-file-preview');
            preview.innerHTML = `
            <div class="file-item">
                <i class="fas fa-file"></i>
                <span class="file-name">${escapeHtml(file.name)}</span>
                <span class="file-size">${formatSize(file.size)}</span>
                <span class="remove-file" onclick="document.getElementById('assignment-file').value=''; document.getElementById('assignment-file-preview').innerHTML=''">
                    <i class="fas fa-times"></i>
                </span>
            </div>
        `;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ============ CR√âATION COURS ============
        document.getElementById('create-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const btn = document.getElementById('submit-course');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...';

            try {
                const courseData = {
                    teacher_email: user.email,
                    title: document.getElementById('course-title').value,
                    description: document.getElementById('course-description').value,
                    category: document.getElementById('course-category').value,
                    is_public: true
                };

                const result = await apiRequest('teachers/create-course.php', {
                    method: 'POST',
                    body: courseData
                });

                if (result.status === 'success') {
                    if (selectedFiles.length > 0) {
                        await uploadFiles(result.data.course_id);
                    }
                    alert('Cours cr√©√© avec succ√®s !');
                    document.getElementById('create-course-form').reset();
                    selectedFiles = [];
                    document.getElementById('file-list').innerHTML = '';
                    showSection('courses');
                } else {
                    alert('Erreur: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur serveur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Cr√©er le cours';
            }
        });

        async function uploadFiles(courseId) {
            const token = localStorage.getItem('token');
            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('course_id', courseId);
                formData.append('title', file.name);

                try {
                    await fetch(`${API_BASE_URL}/teachers/upload-material.php`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token },
                        body: formData
                    });
                } catch (e) {
                    console.error('Erreur upload:', e);
                }
            }
        }

        // ============ QUIZ ============
        document.getElementById('create-quiz-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...';

            try {
                const result = await apiRequest('quizzes/create.php', {
                    method: 'POST',
                    body: {
                        course_id: parseInt(document.getElementById('quiz-course').value),
                        title: document.getElementById('quiz-title').value,
                        description: document.getElementById('quiz-description').value,
                        teacher_email: user.email
                    }
                });

                if (result.status === 'success') {
                    alert('Quiz cr√©√© avec succ√®s !');
                    document.getElementById('create-quiz-form').reset();
                    loadCoursesForSelect();
                    loadTeacherQuizzes();
                } else {
                    alert('Erreur: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur serveur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Cr√©er le quiz';
            }
        });

        // ============ QUIZ - CORRIG√â ============
        async function loadTeacherQuizzes() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.email) {
                    console.error('Email utilisateur non trouv√©');
                    return;
                }

                const result = await apiRequest('teachers/quizzes.php?email=' + encodeURIComponent(user.email));
                const container = document.getElementById('quizzes-list');

                if (!container) return;

                if (result.status === 'success') {
                    const quizzes = result.data || [];

                    if (quizzes.length === 0) {
                        container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px; color: #ccc;"></i>
                            <p>Vous n'avez pas encore cr√©√© de quiz.</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Allez dans l'onglet "Cr√©er un Quiz" pour commencer.</p>
                        </div>
                    `;
                    } else {
                        container.innerHTML = quizzes.map(q => {
                            const isPublished = q.is_published == 1;

                            return `
                            <div class="quiz-item" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); border-left: 4px solid ${isPublished ? '#28a745' : '#ffc107'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: #333;">${escapeHtml(q.title)}</h3>
                                    <span class="badge ${isPublished ? 'badge-success' : 'badge-warning'}" style="padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                        ${isPublished ? '<i class="fas fa-eye"></i> Publi√©' : '<i class="fas fa-eye-slash"></i> Brouillon'}
                                    </span>
                                </div>
                                
                                <p style="color: #666; margin: 10px 0;">${escapeHtml(q.description || 'Aucune description')}</p>
                                
                                <div class="quiz-meta" style="display: flex; gap: 20px; color: #888; font-size: 0.9rem; margin: 15px 0; flex-wrap: wrap;">
                                    <span><i class="fas fa-book"></i> ${escapeHtml(q.course_title)}</span>
                                    <span><i class="fas fa-tag"></i> ${escapeHtml(q.category)}</span>
                                    <span><i class="fas fa-question-circle"></i> ${q.questions_count} question(s)</span>
                                    ${q.time_limit > 0 ? `<span><i class="fas fa-clock"></i> ${q.time_limit} min</span>` : ''}
                                    <span><i class="fas fa-percentage"></i> ${q.passing_score}% pour r√©ussir</span>
                                </div>
                                
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                                    <button onclick="selectQuizForBuilder(${q.id})" class="btn-create" style="padding: 8px 16px; font-size: 0.9rem;">
                                        <i class="fas fa-edit"></i> Modifier / Questions
                                    </button>
                                    ${!isPublished ? `
                                        <button onclick="publishQuiz(${q.id})" style="padding: 8px 16px; font-size: 0.9rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                            <i class="fas fa-upload"></i> Publier
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        }).join('');

                        updateQuizSelect(quizzes);
                    }
                } else {
                    container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>Erreur lors du chargement des quiz</p>
                    </div>
                `;
                }
            } catch (e) {
                console.error('Erreur chargement quiz:', e);
            }
        }

        function selectQuizForBuilder(quizId) {
            const buildTab = document.querySelector('.tab[onclick*="build-quiz-tab"]');
            if (buildTab) {
                switchTab(buildTab, 'build-quiz-tab');
            }

            const select = document.getElementById('build-quiz-select');
            if (select) {
                select.value = quizId;
                loadQuizQuestions();
            }
        }

        async function publishQuiz(quizId) {
            if (!confirm('Voulez-vous vraiment publier ce quiz ?')) return;

            try {
                const result = await apiRequest('quizzes/publish.php?quiz_id=' + quizId, {
                    method: 'POST'
                });

                if (result.status === 'success') {
                    alert('‚úÖ Quiz publi√© avec succ√®s !');
                    loadTeacherQuizzes();
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (e) {
                alert('‚ùå Erreur lors de la publication');
            }
        }

        function updateQuizSelect(quizzes) {
            const select = document.getElementById('build-quiz-select');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Choisir un quiz</option>' +
                quizzes.map(q => `<option value="${q.id}">${escapeHtml(q.title)} (${escapeHtml(q.course_title)})</option>`).join('');

            if (currentValue) select.value = currentValue;
        }

        // ============ CONSTRUCTEUR DE QUESTIONS ============
        function updateOptionInputType() {
            renderOptions();
        }

        function renderOptions() {
            const container = document.getElementById('options-container');
            const type = document.getElementById('question-type').value;
            container.innerHTML = '';

            if (type === 'true_false') {
                currentOptions = [
                    { id: 'tf1', text: 'Vrai', is_correct: true },
                    { id: 'tf2', text: 'Faux', is_correct: false }
                ];
                currentOptions.forEach((opt) => {
                    const row = document.createElement('div');
                    row.className = 'option-row';
                    row.innerHTML = `
                    <input type="radio" name="correct-option" 
                        ${opt.is_correct ? 'checked' : ''} onchange="setCorrectOption('${opt.id}')" style="width: auto;">
                    <input type="text" value="${opt.text}" readonly>
                `;
                    container.appendChild(row);
                });
            } else {
                currentOptions.forEach((opt, index) => {
                    const row = document.createElement('div');
                    row.className = 'option-row';
                    row.innerHTML = `
                    <input type="${type === 'multiple_answer' ? 'checkbox' : 'radio'}" name="correct-option" 
                        ${opt.is_correct ? 'checked' : ''} onchange="toggleCorrectOption('${opt.id}')" style="width: auto;">
                    <input type="text" value="${opt.text}" onchange="updateOptionText('${opt.id}', this.value)" placeholder="Option ${index + 1}">
                    <button type="button" class="btn-remove" onclick="removeOption('${opt.id}')"><i class="fas fa-trash"></i></button>
                `;
                    container.appendChild(row);
                });
            }
        }

        function addOption() {
            const type = document.getElementById('question-type').value;
            if (type === 'true_false') return;

            optionCounter++;
            currentOptions.push({
                id: 'opt_' + optionCounter,
                text: '',
                is_correct: false
            });
            renderOptions();
        }

        function removeOption(id) {
            if (currentOptions.length <= 2) {
                alert('Il faut au moins 2 options');
                return;
            }
            currentOptions = currentOptions.filter(o => o.id !== id);
            renderOptions();
        }

        function updateOptionText(id, text) {
            const opt = currentOptions.find(o => o.id === id);
            if (opt) opt.text = text;
        }

        function toggleCorrectOption(id) {
            const type = document.getElementById('question-type').value;
            const opt = currentOptions.find(o => o.id === id);

            if (type === 'multiple_choice') {
                currentOptions.forEach(o => o.is_correct = false);
                if (opt) opt.is_correct = true;
            } else {
                if (opt) opt.is_correct = !opt.is_correct;
            }
            renderOptions();
        }

        function setCorrectOption(id) {
            currentOptions.forEach(o => o.is_correct = (o.id === id));
        }

        function resetQuestionBuilder() {
            document.getElementById('question-text').value = '';
            document.getElementById('question-points').value = '1';
            document.getElementById('question-explanation').value = '';
            currentOptions = [
                { id: 'opt_1', text: '', is_correct: false },
                { id: 'opt_2', text: '', is_correct: false }
            ];
            optionCounter = 2;
            renderOptions();
        }

        async function saveQuestion() {
            const quizId = document.getElementById('build-quiz-select').value;
            const questionText = document.getElementById('question-text').value;
            const points = document.getElementById('question-points').value;
            const explanation = document.getElementById('question-explanation').value;
            const type = document.getElementById('question-type').value;

            if (!quizId) {
                alert('Veuillez s√©lectionner un quiz');
                return;
            }
            if (!questionText.trim()) {
                alert('Veuillez entrer une question');
                return;
            }
            if (currentOptions.some(o => !o.text.trim())) {
                alert('Veuillez remplir toutes les options');
                return;
            }
            if (!currentOptions.some(o => o.is_correct)) {
                alert('Veuillez s√©lectionner au moins une r√©ponse correcte');
                return;
            }

            try {
                const result = await apiRequest('quizzes/questions.php', {
                    method: 'POST',
                    body: {
                        quiz_id: parseInt(quizId),
                        question: questionText,
                        question_type: type === 'multiple_answer' ? 'multiple_choice' : type,
                        points: parseInt(points),
                        explanation: explanation,
                        options: currentOptions.map(o => ({ text: o.text, is_correct: o.is_correct }))
                    }
                });

                if (result.status === 'success') {
                    alert('Question ajout√©e avec succ√®s !');
                    resetQuestionBuilder();
                    loadQuizQuestions();
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur lors de l\'ajout de la question');
            }
        }

        async function loadQuizQuestions() {
            const quizId = document.getElementById('build-quiz-select').value;
            const container = document.getElementById('question-builder-container');
            const listContainer = document.getElementById('saved-questions-list');

            if (!quizId) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            try {
                const result = await apiRequest(`quizzes/questions.php?quiz_id=${quizId}`);
                if (result.status === 'success' && result.data.length > 0) {
                    listContainer.innerHTML = result.data.map((q, index) => `
                    <div class="saved-question">
                        <h4>Question ${index + 1}: ${escapeHtml(q.question)} <span class="badge badge-info">${q.points} pts</span></h4>
                        <ul class="saved-options">
                            ${q.options.map(opt => `
                                <li class="${opt.is_correct ? 'correct-answer' : 'wrong-answer'}">
                                    ${opt.is_correct ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>'} 
                                    ${escapeHtml(opt.option_text)}
                                </li>
                            `).join('')}
                        </ul>
                        ${q.explanation ? `<p style="margin-top: 10px; color: #666; font-style: italic;"><i class="fas fa-info-circle"></i> ${escapeHtml(q.explanation)}</p>` : ''}
                        <button class="btn-remove" onclick="deleteQuestion(${q.id})" style="margin-top: 10px;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `).join('');
                } else {
                    listContainer.innerHTML = '<p style="color: #666; text-align: center;">Aucune question ajout√©e</p>';
                }
            } catch (error) {
                listContainer.innerHTML = '<p style="color: red; text-align: center;">Erreur de chargement</p>';
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Voulez-vous vraiment supprimer cette question ?')) return;

            try {
                const result = await apiRequest('quizzes/questions.php', {
                    method: 'DELETE',
                    body: { question_id: questionId }
                });

                if (result.status === 'success') {
                    loadQuizQuestions();
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur lors de la suppression');
            }
        }

        // ============ DEVOIRS ============
        document.getElementById('create-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-assignment');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...';

            try {
                const formData = new FormData();
                formData.append('course_id', document.getElementById('assignment-course').value);
                formData.append('title', document.getElementById('assignment-title').value);
                formData.append('description', document.getElementById('assignment-description').value);
                formData.append('due_date', document.getElementById('assignment-due-date').value);
                formData.append('max_points', document.getElementById('assignment-points').value);

                if (document.getElementById('assignment-late').checked) {
                    formData.append('allow_late_submission', '1');
                }

                const fileInput = document.getElementById('assignment-file');
                if (fileInput.files.length > 0) {
                    formData.append('file', fileInput.files[0]);
                }

                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/assignments/create.php`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Devoir cr√©√© avec succ√®s !');
                    document.getElementById('create-assignment-form').reset();
                    document.getElementById('assignment-file-preview').innerHTML = '';
                    loadTeacherAssignments();
                } else {
                    alert('Erreur: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                alert('Erreur serveur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Cr√©er le devoir';
            }
        });

        async function loadTeacherAssignments() {
            try {
                const result = await apiRequest('teachers/assignments.php');
                const container = document.getElementById('assignments-list');

                if (result.status === 'success') {
                    const assignments = result.data || [];
                    if (assignments.length === 0) {
                        container.innerHTML = '<p style="color: #666; text-align: center;">Aucun devoir cr√©√©</p>';
                    } else {
                        container.innerHTML = assignments.map(a => `
                        <div class="assignment-item" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                            <h3>${escapeHtml(a.title)} <span class="badge ${a.submission_count > 0 ? 'badge-warning' : 'badge-success'}">${a.submission_count} soumission(s)</span></h3>
                            <p>${escapeHtml(a.description)}</p>
                            <div class="assignment-meta" style="display: flex; gap: 20px; color: #888; font-size: 0.9rem; margin: 15px 0; flex-wrap: wrap;">
                                <span><i class="fas fa-book"></i> ${escapeHtml(a.course_title)}</span>
                                <span><i class="fas fa-calendar-alt"></i> √Ä rendre: ${new Date(a.due_date).toLocaleString('fr-FR')}</span>
                                <span><i class="fas fa-star"></i> ${a.max_points} points</span>
                                ${a.file_name ? '<span><i class="fas fa-paperclip"></i> Fichier joint</span>' : ''}
                            </div>
                            <div style="margin-top: 15px;">
                                <button onclick="viewSubmissions(${a.id})" class="btn-create" style="padding: 8px 16px; font-size: 0.9rem;">
                                    <i class="fas fa-eye"></i> Voir les soumissions
                                </button>
                            </div>
                        </div>
                    `).join('');
                    }
                }
            } catch (e) {
                console.error('Erreur devoirs:', e);
            }
        }

        // ============ SOUMISSIONS - CORRIG√â ============
        // ============ SOUMISSIONS - CORRIG√â ============
        // ============ SOUMISSIONS - CORRIG√â ============
        async function viewSubmissions(assignmentId) {
            console.log('Chargement des soumissions pour le devoir:', assignmentId);
            currentAssignmentId = assignmentId;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Session expir√©e. Veuillez vous reconnecter.');
                    return;
                }

                const response = await fetch(API_BASE_URL + '/teachers/submissions.php?assignment_id=' + assignmentId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('R√©sultat API soumissions:', result);

                if (result.status === 'success') {
                    if (result.data && result.data.assignment && result.data.submissions) {
                        // Stocker max_points globalement pour la notation
                        window.currentMaxPoints = parseFloat(result.data.assignment.max_points) || 0;
                        renderSubmissionsModal(result.data);
                    } else {
                        alert('Erreur: Structure de donn√©es invalide');
                    }
                } else {
                    alert('Erreur: ' + (result.message || 'Impossible de charger les soumissions'));
                }
            } catch (error) {
                console.error('Erreur fetch soumissions:', error);
                alert('Erreur de connexion lors du chargement des soumissions');
            }
        }

        function renderSubmissionsModal(data) {
            console.log('Donn√©es re√ßues:', data);

            const assignment = data.assignment;
            const submissions = data.submissions || [];

            // CORRECTION : S'assurer que max_points est un nombre valide
            const maxPoints = parseFloat(assignment.max_points) || 0;
            console.log('Max points:', maxPoints);

            // Supprimer l'ancien modal s'il existe
            let oldModal = document.getElementById('submissions-modal');
            if (oldModal) {
                oldModal.remove();
            }

            // Cr√©er le nouveau modal
            const modal = document.createElement('div');
            modal.id = 'submissions-modal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;';

            modal.innerHTML = `
        <div style="background: white; border-radius: 15px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; background: linear-gradient(135deg, #5f6cff, #764ba2); color: white; position: sticky; top: 0; z-index: 10;">
                <h3 style="margin: 0; font-size: 1.3rem;"><i class="fas fa-clipboard-list" style="margin-right: 10px;"></i>Soumissions du devoir</h3>
                <button onclick="closeSubmissionsModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="submissions-content" style="padding: 25px;"></div>
        </div>
    `;

            document.body.appendChild(modal);

            const content = document.getElementById('submissions-content');

            // Info du devoir
            let html = `
        <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9ff, #e8f0fe); border-radius: 12px; border-left: 4px solid #5f6cff;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 1.3rem;">${escapeHtml(assignment.title)}</h4>
            <p style="color: #666; margin: 0 0 15px 0; line-height: 1.5;">${escapeHtml(assignment.description || 'Aucune description')}</p>
            <div style="display: flex; gap: 20px; font-size: 0.9rem; color: #555; flex-wrap: wrap;">
                <span style="display: flex; align-items: center; gap: 5px;"><i class="fas fa-book" style="color: #5f6cff;"></i> ${escapeHtml(assignment.course_title)}</span>
                <span style="display: flex; align-items: center; gap: 5px;"><i class="fas fa-calendar" style="color: #5f6cff;"></i> Date limite: ${new Date(assignment.due_date).toLocaleString('fr-FR')}</span>
                <span style="display: flex; align-items: center; gap: 5px;"><i class="fas fa-star" style="color: #ffc107;"></i> <strong>${maxPoints}</strong> points maximum</span>
            </div>
        </div>
    `;

            if (submissions.length === 0) {
                html += `
            <div style="text-align: center; padding: 60px 20px; color: #666;">
                <i class="fas fa-inbox" style="font-size: 64px; color: #ddd; margin-bottom: 20px;"></i>
                <h3 style="margin: 0 0 10px 0; color: #888;">Aucune soumission pour le moment</h3>
                <p style="margin: 0;">Les √©tudiants n'ont pas encore rendu ce devoir.</p>
            </div>
        `;
            } else {
                html += `<div style="margin-bottom: 15px; font-size: 1.1rem; color: #333;"><strong>üìä ${submissions.length} soumission(s)</strong></div>`;
                html += '<div style="display: flex; flex-direction: column; gap: 20px;">';

                submissions.forEach(function (sub) {
                    const submittedDate = sub.submitted_at
                        ? new Date(sub.submitted_at).toLocaleString('fr-FR')
                        : '<span style="color: #dc3545;">Non soumis</span>';
                    const isGraded = sub.status === 'graded';
                    const isLate = sub.is_late == 1;

                    // Construction du contenu
                    let submissionContent = '';

                    if (sub.submission_text && sub.submission_text.trim() !== '') {
                        submissionContent += `
                    <div style="margin: 20px 0; padding: 20px; background: #f8f9ff; border-radius: 10px; border-left: 4px solid #5f6cff;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: #5f6cff; font-weight: 600;">
                            <i class="fas fa-comment-alt"></i> R√©ponse textuelle
                        </div>
                        <div style="color: #444; line-height: 1.8; white-space: pre-wrap; font-size: 0.95rem; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">${escapeHtml(sub.submission_text)}</div>
                    </div>
                `;
                    }

                    if (sub.file_path && sub.file_path.trim() !== '') {
                        const fileName = sub.file_path.split('/').pop();
                        submissionContent += `
                    <div style="margin: 20px 0;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: #333; font-weight: 600;">
                            <i class="fas fa-paperclip" style="color: #28a745;"></i> Fichier joint
                        </div>
                        <a href="${sub.file_path}" target="_blank" style="display: inline-flex; align-items: center; gap: 12px; padding: 15px 20px; background: #e8f0fe; color: #1967d2; text-decoration: none; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s;" onmouseover="this.style.borderColor='#1967d2'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='transparent'; this.style.transform='none';">
                            <i class="fas fa-file" style="font-size: 24px;"></i>
                            <div>
                                <div style="font-weight: 600;">${escapeHtml(fileName)}</div>
                                <div style="font-size: 0.85rem; color: #666;">Cliquez pour ouvrir</div>
                            </div>
                            <i class="fas fa-external-link-alt" style="margin-left: 15px;"></i>
                        </a>
                    </div>
                `;
                    }

                    if (submissionContent === '') {
                        submissionContent = `
                    <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-radius: 10px; color: #856404; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div style="font-weight: 600;">Aucun contenu soumis</div>
                    </div>
                `;
                    }

                    // CORRECTION : Utiliser maxPoints (la variable locale) au lieu de assignment.max_points
                    html += `
                <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #5f6cff, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.3rem;">
                                    ${sub.first_name ? sub.first_name.charAt(0).toUpperCase() : '?'}${sub.last_name ? sub.last_name.charAt(0).toUpperCase() : '?'}
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #2f3542;">${escapeHtml(sub.first_name)} ${escapeHtml(sub.last_name)}</div>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 4px;">
                                        <i class="fas fa-envelope" style="margin-right: 5px;"></i>${escapeHtml(sub.email)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: #888; margin-bottom: 8px;">
                                <i class="fas fa-clock" style="margin-right: 5px;"></i>${submittedDate}
                                ${isLate ? '<span style="color: #dc3545; font-weight: 600; margin-left: 10px;"><i class="fas fa-exclamation-circle"></i> EN RETARD</span>' : ''}
                            </div>
                            ${isGraded ?
                            `<div style="background: #d4edda; color: #155724; padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check-circle"></i> Not√©: ${sub.grade}/${maxPoints}
                                </div>` :
                            `<div style="background: #fff3cd; color: #856404; padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-hourglass-half"></i> En attente
                                </div>`
                        }
                        </div>
                    </div>
                    
                    ${submissionContent}
                    
                    <div style="margin-top: 25px; padding: 20px; background: #f8f9ff; border-radius: 10px; border: 2px solid #e0e2ff;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 15px;">
                            <i class="fas fa-star" style="color: #ffc107; margin-right: 8px;"></i>Notation
                        </div>
                        <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                            <div style="flex: 0 0 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.9rem;">
                                    Note / <strong style="color: #5f6cff; font-size: 1.1rem;">${maxPoints}</strong> points
                                </label>
                                <input type="number" 
                                    id="grade-${sub.submission_id}" 
                                    placeholder="0-${maxPoints}" 
                                    min="0" 
                                    max="${maxPoints}" 
                                    step="0.5"
                                    value="${sub.grade !== null ? sub.grade : ''}" 
                                    style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <button onclick="gradeSubmission(${sub.submission_id}, ${maxPoints})" 
                                style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-save" style="margin-right: 8px;"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            `;
                });

                html += '</div>';
            }

            content.innerHTML = html;
            console.log('Modal affich√© avec maxPoints:', maxPoints);
        }

        // CORRECTION : Fonction de fermeture am√©lior√©e
        function closeSubmissionsModal() {
            console.log('Fermeture du modal');
            const modal = document.getElementById('submissions-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.remove(); // Supprimer compl√®tement le modal du DOM
            }
            currentAssignmentId = null;
            window.currentMaxPoints = null;
        }

        // CORRECTION : Fonction de notation avec v√©rification
        async function gradeSubmission(submissionId, maxPoints) {
            console.log('Notation:', { submissionId, maxPoints, currentMaxPoints: window.currentMaxPoints });

            // Utiliser la valeur pass√©e en param√®tre ou la valeur globale
            const validMaxPoints = maxPoints || window.currentMaxPoints || 0;

            if (validMaxPoints <= 0) {
                alert('‚ùå Erreur: Points maximum non d√©finis. Veuillez recharger la page.');
                return;
            }

            const gradeInput = document.getElementById('grade-' + submissionId);
            const grade = gradeInput ? parseFloat(gradeInput.value) : null;

            console.log('Valeurs:', { grade, validMaxPoints });

            if (grade === null || isNaN(grade)) {
                alert('‚ö†Ô∏è Veuillez entrer une note valide');
                return;
            }

            if (grade < 0 || grade > validMaxPoints) {
                alert(`‚ö†Ô∏è La note doit √™tre comprise entre 0 et ${validMaxPoints}`);
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(API_BASE_URL + '/teachers/grade.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        grade: grade
                    })
                });

                const result = await response.json();
                console.log('R√©sultat notation:', result);

                if (result.status === 'success') {
                    alert('‚úÖ Note enregistr√©e avec succ√®s !');
                    // Recharger les soumissions
                    if (currentAssignmentId) {
                        viewSubmissions(currentAssignmentId);
                    }
                } else {
                    alert('‚ùå Erreur: ' + (result.message || 'Impossible d\'enregistrer'));
                }
            } catch (error) {
                console.error('Erreur notation:', error);
                alert('‚ùå Erreur de connexion');
            }
        }

        // Fermer le modal en cliquant √† l'ext√©rieur
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('submissions-modal');
            if (modal && e.target === modal) {
                closeSubmissionsModal();
            }
        });

        // Fermer avec la touche Echap
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeSubmissionsModal();
            }
        });
        // ============ UTILITAIRES ============
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');

            if (!token || user.role !== 'teacher') {
                window.location.href = 'login.html';
                return;
            }

            initFileUpload();
            resetQuestionBuilder();
            loadTeacherDashboard();

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('assignment-due-date').min = now.toISOString().slice(0, 16);
        });
    </script>
</body>

</html>